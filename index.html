<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outil d'Apprentissage du Français</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Styles personnalisés pour la grille et la typographie */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f7f7f7;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            padding: 20px;
            max-width: 1200px;
            margin: 20px auto;
        }

        .grid-item {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            position: relative;
        }

        .grid-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        }

        .grid-item.active {
            background-color: #d1e7dd; /* Vert clair pour l'activation */
            border-color: #198754;
        }

        .letter {
            font-size: 2.5rem;
            font-weight: bold;
            color: #333;
            line-height: 1;
        }

        .sound-icon {
            position: absolute;
            top: 5px;
            right: 5px;
            color: #007bff;
            font-size: 1rem;
        }

        /* Styles spécifiques pour le lecteur audio */
        #audio-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #212529;
            color: white;
            padding: 10px 20px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
        }

        #audio-controls button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #audio-controls button:hover {
            background-color: #0056b3;
        }

        #message-area {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            padding: 10px;
            text-align: center;
            border-radius: 0 0 5px 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            transition: opacity 0.3s, transform 0.3s;
        }

        .message-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* Styles pour l'IA et les sources */
        #ai-response-area {
            border-left: 5px solid #007bff;
            padding-left: 15px;
        }

        .source-link {
            color: #007bff;
            text-decoration: none;
            font-size: 0.85rem;
        }
        .source-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>

    <header class="text-center py-6 bg-white shadow-md">
        <h1 class="text-3xl font-extrabold text-gray-800">Apprentissage de la Prononciation du Français</h1>
        <p class="text-gray-600 mt-2">Cliquez sur une lettre ou un mot pour entendre la prononciation.</p>
    </header>

    <div id="message-area" class="hidden"></div>

    <div id="letter-grid" class="grid-container">
        </div>

    <div class="max-w-4xl mx-auto mt-8 p-6 bg-white rounded-lg shadow-lg hidden" id="ai-response-area">
        <div id="ai-content" class="text-gray-700 mb-4">
            </div>
        <div id="ai-sources" class="text-sm text-gray-500 border-t pt-2 mt-2">
            </div>
        <div class="mt-4 flex space-x-4">
            <button id="tts-read-button" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 disabled:opacity-50" disabled>Lire la réponse</button>
            <button id="tts-stop-button" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 disabled:opacity-50" disabled>Arrêter la lecture</button>
        </div>
    </div>


    <div id="audio-controls" class="hidden">
        <audio id="audio-player" controls class="hidden"></audio>
        <div id="current-word" class="text-lg font-semibold">Prêt.</div>
        <div id="audio-buttons" class="space-x-4">
            <button id="play-next-button" disabled>Mot Suivant</button>
            <button id="play-all-button">Lire Tout</button>
        </div>
    </div>
    
    <script>
        // --- Configuration API Gemini ---
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        // NOUVEAU : Point d'accès de votre fonction Netlify.
        const GEMINI_FUNCTION_URL = "/.netlify/functions/gemini"; 
        // NOTE: La clé API n'est plus utilisée directement ici. Elle est sur Netlify.
        const API_KEY = ""; 
        
        // --- Configuration MP3 ---
        // Le caractère est ajouté en minuscule (ex: 'A.mp3' devient 'a.mp3')
        const CHEMIN_DE_BASE_MP3_URL = "https://raw.githubusercontent.com/devidprinciotta/alphabet-phon-tique/main/Mes%20sons%20alphabet/";

        // --- LISTE DES MOTS CENSURÉS (EN MINUSCULES) ---
        // Liste exhaustive collectée via recherche Internet (gros mots, obscénités, termes sexuels)
        const BANNED_WORDS = [
            // Injuries / Grossièretés communes
            "putain", "bordel", "merde", "con", "conne", "connard", "salaud", "salope", "pute", 
            "chier", "foutre", "enculer", "branleur", "cul", "couille", "bite", "chatte", 
            "ta gueule", "casse-toi", "niquer", "crétin", "idiot", "imbécile", "abruti", 
            "brute", "débile", "gogol", "mongol", "tarlouze", "pd", "pédé", "tapette", 
            "bougnoule", "nègre", "racailles", "raciste", "juif", "arabe", "nazi", 
            // Verbes / Actions obscènes
            "violer", "tripoter", "sucer", "baiser", "pénis", "vagin", "sexe", "sodomie",
            // Termes religieux (potentiellement offensants dans certains contextes)
            "satan", "lucifer", "diable", "démon",
            // Divers termes crus
            "caca", "pipi", "vomi"
        ];
        
        // --- VARIABLES GLOBALES ---
        let currentWordElement = null;
        let ttsQueue = [];
        let isProcessingQueue = false;
        let isAILoading = false;
        const audioPlayer = document.getElementById('audio-player');
        const playNextButton = document.getElementById('play-next-button');
        const playAllButton = document.getElementById('play-all-button');
        const currentWordDisplay = document.getElementById('current-word');
        const aiResponseArea = document.getElementById('ai-response-area');
        const aiContent = document.getElementById('ai-content');
        const aiSources = document.getElementById('ai-sources');
        const ttsReadButton = document.getElementById('tts-read-button');
        const ttsStopButton = document.getElementById('tts-stop-button');
        
        /**
         * Affiche un message d'information ou d'erreur.
         * @param {string} message Le texte à afficher.
         * @param {boolean} isError Vrai si c'est un message d'erreur, faux sinon.
         */
        window.displayMessage = function(message, isError) {
            const messageArea = document.getElementById('message-area');
            if (message) {
                messageArea.textContent = message;
                messageArea.classList.remove('hidden', 'message-success', 'message-error');
                messageArea.classList.add(isError ? 'message-error' : 'message-success');
                setTimeout(() => {
                    messageArea.classList.add('hidden');
                }, 5000);
            } else {
                messageArea.classList.add('hidden');
            }
        }

        /**
         * Vérifie si un mot est sur la liste de censure.
         * @param {string} word Le mot à vérifier.
         * @returns {boolean} Vrai si le mot est banni.
         */
        function isWordBanned(word) {
            return BANNED_WORDS.includes(word.toLowerCase());
        }

        /**
         * Gère l'état de chargement pour les appels IA.
         * @param {boolean} loading
         */
        function setLoadingAI(loading) {
            isAILoading = loading;
            // Optionnel: Désactiver des boutons ou afficher un spinner
        }

        /**
         * Affiche la réponse de l'IA.
         * @param {string} text La réponse formatée.
         * @param {Array<Object>} sources Les sources trouvées.
         */
        function displayAIResponse(text, sources) {
            aiResponseArea.classList.remove('hidden');
            // Assurez-vous que le texte est correctement affiché (gestion des retours à la ligne)
            aiContent.innerHTML = `<p>${text.replace(/\n/g, '<br>')}</p>`;

            aiSources.innerHTML = '';
            if (sources && sources.length > 0) {
                aiSources.innerHTML = 'Sources: ' + sources.map((s, index) => 
                    `<a href="${s.uri}" target="_blank" class="source-link" title="${s.title}">${index + 1}</a>`
                ).join(' ');
            }
            
            ttsReadButton.disabled = false;
            ttsStopButton.disabled = true;
        }

        // --- Fonctions de Synthèse Vocale (TTS) ---

        /**
         * Lit le texte de l'IA en utilisant la synthèse vocale.
         * @param {string} text Le texte à lire.
         */
        function readAIResponse(text) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            const voices = window.speechSynthesis.getVoices();
            // Tenter de trouver une voix française
            utterance.voice = voices.find(voice => voice.lang === 'fr-FR') || voices[0];
            utterance.rate = 0.9; // Vitesse de lecture légèrement réduite

            utterance.onstart = () => {
                ttsReadButton.disabled = true;
                ttsStopButton.disabled = false;
            };

            utterance.onend = () => {
                ttsReadButton.disabled = false;
                ttsStopButton.disabled = true;
            };

            utterance.onerror = (event) => {
                window.displayMessage(`Erreur de lecture TTS : ${event.error}`, true);
                ttsReadButton.disabled = false;
                ttsStopButton.disabled = true;
            };

            window.speechSynthesis.speak(utterance);
        }

        /**
         * Arrête la lecture TTS en cours.
         */
        function stopTTS() {
            window.speechSynthesis.cancel();
            ttsReadButton.disabled = false;
            ttsStopButton.disabled = true;
        }

        // --- Logique de l'IA (Fonction sécurisée) ---

        /**
         * Appelle l'API Gemini pour obtenir une définition et un exemple pour le mot donné.
         * Le code utilise la Netlify Function pour sécuriser la clé API.
         */
        window.fetchGeminiDefinition = async function(word) {
            const wordToSearch = word.trim();
            const firstWord = wordToSearch.split(/\s+/).filter(w => w.length > 0)[0] || '';

            // 1. VÉRIFICATION DE LA CENSURE
            if (isWordBanned(firstWord)) {
                window.displayMessage("Censure: La définition et l'exemple pour ce mot sont bloqués.", true);
                aiResponseArea.classList.remove('hidden');
                aiContent.innerHTML = `<h3 class="text-xl font-bold mb-2 text-red-700">${firstWord.toUpperCase()}</h3><p class="text-red-600 font-semibold">Le mot '${firstWord}' figure sur la liste des mots bannis. La recherche de définition est bloquée par mesure de sécurité.</p>`;
                aiSources.innerHTML = '';
                setLoadingAI(false);
                return;
            }
            
            // 2. VÉRIFICATION (Le code client n'a plus besoin de la clé, elle est gérée par le serveur)
            if (!wordToSearch || isAILoading) return;
            
            const words = wordToSearch.split(/\s+/).filter(w => w.length > 0);
            if (words.length > 1) {
                window.displayMessage("Veuillez saisir un seul mot pour la recherche de définition.", true);
                return;
            }

            // Arrêter toute lecture en cours 
            window.speechSynthesis.cancel();
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            ttsQueue = [];
            isProcessingQueue = false;
            
            setLoadingAI(true);
            window.displayMessage("", false); 
            
            const systemPrompt = "Vous êtes un tuteur de vocabulaire pour enfants et un expert en langue française. Fournissez une courte définition simple et un exemple d'utilisation du mot demandé. Formatez la réponse avec 'Définition: [votre définition]\\nExemple: [votre exemple]'. La réponse doit être en français. Ne proposez aucun autre dialogue ou texte que la définition et l'exemple.";
            const userQuery = `Donnez une définition et un exemple pour le mot : ${wordToSearch}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const maxRetries = 3;
            let currentDelay = 1000; 
            
            for (let i = 0; i < maxRetries; i++) {
                try {
                    // *** APPEL À LA NETLIFY FUNCTION ***
                    // Utilise l'URL relative /netlify/functions/gemini
                    const response = await fetch(GEMINI_FUNCTION_URL, { 
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        if (i < maxRetries - 1) {
                            await new Promise(resolve => setTimeout(resolve, currentDelay));
                            currentDelay *= 2; 
                            continue; 
                        } else {
                            throw new Error("Taux de requêtes API dépassé après plusieurs tentatives.");
                        }
                    }

                    if (!response.ok) {
                        // Tenter de lire le corps de l'erreur
                        const errorBody = await response.text(); 
                        
                        // Si le statut est 500 et qu'il y a du JSON (erreur de clé serveur)
                        try {
                             const jsonError = JSON.parse(errorBody);
                             throw new Error(`Erreur de l'API (via Serveur) : ${jsonError.error || response.statusText}`);
                        } catch (e) {
                            // Erreur HTML (dépendance manquante, 404 de la fonction) ou JSON mal formé
                            throw new Error(`Erreur de l'API (via Serveur) : Statut ${response.status}. Vérifiez la console pour l'erreur brute.`);
                        }
                    }

                    // La fonction Netlify retourne la réponse JSON directe de l'IA
                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        
                        let sources = [];
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title);
                        }

                        displayAIResponse(text, sources);
                        setLoadingAI(false);
                        return; // Success
                    } else {
                        throw new Error("Réponse de l'IA vide ou mal formée.");
                    }

                } catch (error) {
                    console.error("Erreur Gemini (Via Serveur):", error);
                    window.displayMessage(`Impossible de récupérer la définition : ${error.message}.`, true);
                    setLoadingAI(false);
                    return; // Exit after failure
                }
            }
        }


        // --- Logique de lecture MP3 et de la grille ---

        /**
         * Joue un fichier MP3 à partir d'un nom de mot/lettre.
         * @param {string} word Le mot ou la lettre.
         */
        function playMp3(word) {
            if (!word) return;
            
            // Annuler la lecture en cours pour la synthèse vocale
            window.speechSynthesis.cancel();
            
            const fileName = `${word.toLowerCase()}.mp3`;
            const url = `${CHEMIN_DE_BASE_MP3_URL}${fileName}`;
            
            currentWordDisplay.textContent = `Lecture en cours: ${word}`;
            
            audioPlayer.src = url;
            audioPlayer.play().catch(error => {
                console.error("Erreur de lecture audio:", error);
                window.displayMessage(`Erreur: Impossible de jouer le son pour "${word}". Le fichier "${fileName}" est peut-être manquant.`, true);
                currentWordDisplay.textContent = "Erreur de lecture.";
            });
        }

        /**
         * Gère la lecture du mot suivant dans la file d'attente.
         */
        function playNextInQueue() {
            if (ttsQueue.length > 0) {
                const wordElement = ttsQueue.shift();
                if (wordElement) {
                    currentWordElement = wordElement;
                    const word = wordElement.getAttribute('data-word');
                    playMp3(word);
                    updateButtonState();
                } else {
                    playNextInQueue(); // Passer au mot suivant si l'élément est null
                }
            } else {
                // File d'attente vide, fin de la lecture
                isProcessingQueue = false;
                playAllButton.textContent = 'Lire Tout';
                currentWordDisplay.textContent = 'Prêt.';
                updateButtonState();
            }
        }

        /**
         * Met à jour l'état des boutons de contrôle audio.
         */
        function updateButtonState() {
            const hasNext = ttsQueue.length > 0;
            playNextButton.disabled = !hasNext && !audioPlayer.seeking;
            playAllButton.disabled = isProcessingQueue;
        }

        /**
         * Initialise la grille des lettres/mots.
         */
        function initializeGrid() {
            const letterGrid = document.getElementById('letter-grid');
            const data = [
                // Vos données originales sont ici
                { type: 'letter', content: 'A', details: 'A comme Arbre' },
                { type: 'letter', content: 'B', details: 'B comme Ballon' },
                { type: 'letter', content: 'C', details: 'C comme Chat' },
                { type: 'letter', content: 'D', details: 'D comme Domino' },
                { type: 'letter', content: 'E', details: 'E comme Éléphant' },
                { type: 'letter', content: 'F', details: 'F comme Fleur' },
                { type: 'letter', content: 'G', details: 'G comme Girafe' },
                { type: 'letter', content: 'H', details: 'H comme Hérisson' },
                { type: 'letter', content: 'I', details: 'I comme Igloo' },
                { type: 'letter', content: 'J', details: 'J comme Jupe' },
                { type: 'letter', content: 'K', details: 'K comme Kangourou' },
                { type: 'letter', content: 'L', details: 'L comme Lion' },
                { type: 'letter', content: 'M', details: 'M comme Maison' },
                { type: 'letter', content: 'N', details: 'N comme Nuage' },
                { type: 'letter', content: 'O', details: 'O comme Orange' },
                { type: 'letter', content: 'P', details: 'P comme Poisson' },
                { type: 'letter', content: 'Q', details: 'Q comme Queue' },
                { type: 'letter', content: 'R', details: 'R comme Rat' },
                { type: 'letter', content: 'S', details: 'S comme Soleil' },
                { type: 'letter', content: 'T', details: 'T comme Tigre' },
                { type: 'letter', content: 'U', details: 'U comme Usine' },
                { type: 'letter', content: 'V', details: 'V comme Vache' },
                { type: 'letter', content: 'W', details: 'W comme Wagon' },
                { type: 'letter', content: 'X', details: 'X comme Xylophone' },
                { type: 'letter', content: 'Y', details: 'Y comme Yeux' },
                { type: 'letter', content: 'Z', details: 'Z comme Zèbre' },
                // Ajout de mots à titre d'exemple
                { type: 'word', content: 'Table', details: 'Un objet' },
                { type: 'word', content: 'Chaise', details: 'Pour s\'asseoir' },
            ];

            data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'grid-item';
                div.setAttribute('data-word', item.content);
                div.setAttribute('data-details', item.details);
                div.innerHTML = `
                    <div class="letter">${item.content}</div>
                    <div class="text-sm text-gray-500 mt-1">${item.details}</div>
                    <span class="sound-icon">&#128266;</span>
                    <button class="mt-2 px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600" onclick="window.fetchGeminiDefinition('${item.content}')">
                        Définition & Exemple (IA)
                    </button>
                `;
                
                div.addEventListener('click', (e) => {
                    // Empêcher l'événement de se propager au bouton IA
                    if (e.target.tagName !== 'BUTTON') {
                        // Annuler la lecture en cours
                        window.speechSynthesis.cancel();
                        audioPlayer.pause();
                        currentWordElement = div;
                        playMp3(div.getAttribute('data-word'));
                        document.querySelectorAll('.grid-item').forEach(el => el.classList.remove('active'));
                        div.classList.add('active');
                        document.getElementById('audio-controls').classList.remove('hidden');
                    }
                });
                
                letterGrid.appendChild(div);
            });
        }

        // --- Événements et Initialisation ---

        audioPlayer.onended = () => {
            if (isProcessingQueue) {
                playNextInQueue();
            } else {
                currentWordDisplay.textContent = 'Terminé.';
                updateButtonState();
            }
        };

        playNextButton.onclick = playNextInQueue;

        playAllButton.onclick = () => {
            // Recharger la queue avec tous les mots/lettres
            ttsQueue = Array.from(document.querySelectorAll('.grid-item'));
            isProcessingQueue = true;
            playAllButton.textContent = 'En cours...';
            playAllButton.disabled = true;
            playNextInQueue();
        };

        ttsReadButton.onclick = () => {
            const textToRead = aiContent.textContent;
            if (textToRead) {
                readAIResponse(textToRead);
            }
        };
        
        ttsStopButton.onclick = stopTTS;

        // Assurez-vous d'initialiser la grille après que le DOM soit chargé.
        document.addEventListener('DOMContentLoaded', () => {
            initializeGrid();
        });

    </script>

</body>
</html>
