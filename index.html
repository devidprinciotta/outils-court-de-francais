<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synth√®se Vocale TTS - Version 6.3</title>
    <!-- Chargement de Tailwind CSS pour un design moderne et responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chargement des polices: Dancing Script (cursif long et gras) et Inter (imprim√©) -->
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* La police principale Inter est maintenue */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* FOND D'√âCRAN PASTEL ARC-EN-CIEL L√âGER */
            background: linear-gradient(135deg, #e3f2fd 0%, #fff3e0 25%, #fce4ec 50%, #e0f7fa 75%, #f3e5f5 100%);
        }
        
        /* STYLE DES BOUTONS V4.5 */
        .btn-letter, .btn-special {
            transition: all 0.15s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            /* Augmenter la taille du bouton pour contenir les deux caract√®res */
            height: 4rem; /* Nouvelle taille pour un meilleur affichage */
            position: relative; /* N√©cessaire pour positionner les span enfants */
            padding: 0; /* Retirer le padding par d√©faut */
            overflow: hidden;
            font-weight: 700;
        }
        .btn-letter:hover, .btn-special:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        /* Style V4.5: Bleu pour les lettres majuscules (A-Z) */
        .btn-letter { background-color: #bfdbfe; color: #1d4ed8; } 
        /* Style V4.5: Turquoise pour les accents/sp√©ciaux */
        .btn-special { background-color: #e0f2f1; color: #00796b; } 

        /* NOUVEAU STYLE: Positionnement des caract√®res */
        .char-display {
            position: absolute;
            font-family: 'Inter', sans-serif; /* Imprim√© par d√©faut (Mode Normal) */
            transition: font-family 0.3s ease;
        }

        .char-upper {
            top: 0.25rem; /* Haut */
            left: 0.5rem; /* Gauche */
            font-size: 1.5rem; /* Grande taille pour la majuscule */
        }
        .char-lower {
            bottom: 0.25rem; /* Bas */
            right: 0.5rem; /* Droite */
            font-size: 1.25rem; /* Petite taille pour la minuscule */
            opacity: 0.7; /* L√©g√®rement plus p√¢le */
        }

        /* CLASSE DE BASCULE POUR LES CARACT√àRES SUR LES BOUTONS */
        .handwriting-font-on-button {
            font-family: 'Dancing Script', cursive !important;
            font-weight: 700 !important;
        }

        .btn-action {
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn-action:hover {
            transform: scale(1.02);
        }
        .btn-action:disabled {
            background-color: #a8b9c9;
            cursor: not-allowed;
            transform: none;
        }
        /* Style pour l'indicateur de chargement */
        .loader {
          border-top-color: #3b82f6;
          -webkit-animation: spin 1s linear infinite;
          animation: spin 1s linear infinite;
        }

        @-webkit-keyframes spin {
          0% { -webkit-transform: rotate(0deg); }
          100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        
        /* STYLE UNIFORME POUR LE CADRE D'√âCRITURE */
        .text-input-base {
            height: 5rem;     
            line-height: 1;    
            padding-top: 0;   
            padding-bottom: 0;
            overflow: hidden; 
            font-size: 5.0rem; 
        }
        
        /* STYLE SP√âCIFIQUE AU MODE MANUSCRIT (S'APPLIQUE UNIQUEMENT AU CHAMP TEXTE) */
        .handwriting-mode {
            font-family: 'Dancing Script', cursive; 
            font-weight: 700; 
            font-size: 3.8rem; /* Ajust√© pour mieux tenir sur une seule ligne */
        }
        
        /* STYLES POUR LE BOUTON COMMUTATEUR √âMOJI */
        .vocal-toggle-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px; /* Taille fixe, l√©g√®rement plus grand */
            height: 48px;
            border-radius: 50%;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-size: 1.5rem; /* Taille de l'emoji */
            border: 2px solid transparent;
        }

        /* √âtat Inactif (TTS Actif, Oreille) */
        .vocal-toggle-btn.tts-active {
            background-color: #D1D5DB; /* bg-gray-300 */
            border-color: #9CA3AF;
            opacity: 0.9;
        }

        /* √âtat Actif (MP3 Vocal Actif, Haut-parleur) */
        .vocal-toggle-btn.mp3-active {
            background-color: #8B5CF6; /* bg-violet-500 */
            border-color: #6D28D9;
            color: white; /* L'emoji reste color√©, mais le bouton a une couleur de fond */
            box-shadow: 0 8px 15px rgba(139, 92, 246, 0.4);
        }
    </style>
    <!-- Code Firebase minimaliste -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        window.firebaseApp = null;
        window.firebaseAuth = null;
        window.currentUserId = null;
        window.isAuthReady = false;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        async function initFirebaseAndAuth() {
            try {
                if (!firebaseConfig) {
                    console.error("Firebase config is missing.");
                    window.isAuthReady = true; 
                    return;
                }
                
                window.firebaseApp = initializeApp(firebaseConfig);
                window.firebaseAuth = getAuth(window.firebaseApp);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(window.firebaseAuth, initialAuthToken);
                } else {
                    await signInAnonymously(window.firebaseAuth);
                }

                window.currentUserId = window.firebaseAuth.currentUser?.uid || 'anonymous';
                window.isAuthReady = true;
                console.log("Firebase Auth Ready. User ID:", window.currentUserId);
            } catch (error) {
                console.error("Firebase authentication error:", error);
                window.isAuthReady = true;
            }
        }

        document.addEventListener('DOMContentLoaded', initFirebaseAndAuth);
    </script>
</head>

<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-5xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl">
        
        <!-- Mention de l'auteur -->
        <header class="text-center mb-2">
            <p class="text-xl font-extrabold text-gray-500 italic">
                Cr√©√© par le papa de Enrique
            </p>
        </header>

        <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center border-b pb-4">
            Synth√®se Vocale TTS - Version <span class="text-green-600">6.3</span>
        </h1>
        
        <!-- Section 1: Grille de l'Alphabet et Caract√®res Sp√©ciaux (MAJUSCULES PAR D√âFAUT) -->
        <div class="mb-8">
            <div class="flex items-center justify-end space-x-3 mb-4">
                
                <!-- NOUVEAU BOUTON : Interrupteur Vocal MP3 -->
                <!-- L'emoji initial est l'oreille (TTS actif) -->
                <button 
                    id="vocal-toggle-btn" 
                    onclick="toggleVocalMode()"
                    title="Basculer entre TTS (Oreille) et Vocal MP3 (Haut-parleur)"
                    class="vocal-toggle-btn tts-active"
                >
                    <span id="vocal-emoji">üëÇ</span> 
                </button>
                
                <!-- Bouton de bascule de police -->
                <button 
                    id="toggle-handwriting" 
                    onclick="toggleHandwritingMode()"
                    class="text-sm font-medium transition duration-150 py-1 px-3 border rounded-full shadow-md whitespace-nowrap"
                >
                    <!-- Libell√© dynamique -->
                </button>
            </div>
            
            <!-- Conteneur pour les LETTRES NORMALES -->
            <div id="letter-grid" class="grid grid-cols-7 sm:grid-cols-9 md:grid-cols-13 gap-2 mb-6">
                <!-- Les lettres A-Z seront inject√©es ici par JS -->
            </div>
            
            <!-- Conteneur pour les CARACT√àRES SP√âCIAUX -->
            <div id="special-char-grid" class="grid grid-cols-7 sm:grid-cols-9 md:grid-cols-13 gap-2">
                <!-- Les accents seront inject√©s ici par JS -->
            </div>
        </div>
        
        <!-- Section 2: Espace de Traitement de Texte et Lecture -->
        <div>
            <div class="flex items-stretch space-x-3 mb-4">
                <input
                    type="text"
                    id="text-input"
                    placeholder="Le texte s'affiche ici... (Max 1 mot pour la d√©finition IA)"
                    class="text-input-base flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg shadow-inner"
                    value=""
                    oninput="updateButtonStates(this.value);"
                >
            </div>
            
            <!-- Groupe de boutons d'action (Maintenant 3 colonnes) -->
            <div class="grid grid-cols-3 gap-3 mb-4">
                
                <!-- Bouton Parler (TTS Natif) -->
                <button
                    id="speak-btn"
                    onclick="generateAndPlayWordAudio()"
                    disabled
                    class="btn-action px-4 py-3 bg-green-600 text-white font-bold rounded-lg flex items-center justify-center shadow-lg hover:bg-green-700"
                >
                    <span id="speak-text">Parler</span>
                    <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.121-7.072a8 8 0 010 11.314m-12.284-8.151l-4.25 4.25a1 1 0 000 1.414l4.25 4.25a1 1 0 001.414 0l4.25-4.25a1 1 0 000-1.414l-4.25-4.25a1 1 0 00-1.414 0zM15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>

                <!-- Bouton Effacer -->
                <button
                    id="clear-btn"
                    onclick="clearText()"
                    class="btn-action px-4 py-3 bg-red-500 text-white font-semibold rounded-lg shadow hover:bg-red-600"
                >
                    Effacer
                </button>

                <!-- Bouton IA pour la D√©finition -->
             <button

                    id="ai-btn"

                    onclick="callAIGemini(textInput.value)"

                    disabled

                    class="btn-action px-4 py-3 bg-purple-600 text-white font-bold rounded-lg flex items-center justify-center shadow-lg hover:bg-purple-700"

                >

                    <span id="ai-text">D√©finition & Exemple (IA)</span>

                </button>
            </div>
        </div>
        
        <!-- Zone de message pour les erreurs/infos -->
        <div id="message-area" class="mt-6 p-4 bg-yellow-100 border border-yellow-300 text-yellow-800 rounded-lg hidden"></div>
        
        <!-- Nouvelle zone de r√©ponse de l'IA -->
        <div id="ai-response-area" class="mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg hidden">
            <div id="ai-content" class="text-gray-800 leading-relaxed"></div>
            <div id="ai-sources" class="mt-4 pt-2 border-t border-gray-200 text-xs text-gray-500"></div>
        </div>
        
        <audio id="audio-player" class="hidden"></audio>

    </div>

    <script type="text/javascript">
        
        // --- Configuration API Gemini ---
        const GEMINI_API_URL = '/.netlify/functions/index';
        
        // ***********************************************************************************
        // ***********************************************************************************
        // C'EST ICI QUE DOIT SE TROUVER LA CL√â API GEMINI !
        // Collez votre cl√© API ici, entre les guillemets :
        const API_KEY = ""; 
        // ***********************************************************************************
        // ***********************************************************************************
        
        // --- Configuration MP3 ---
        // CHEMIN DE BASE MP3 : Le caract√®re est ajout√© en minuscule (ex: 'a.mp3', '√©.mp3')
        const MP3_BASE_URL = "https://raw.githubusercontent.com/devidprinciotta/Alphabet-phon-tique/main/Mes%20son%20alphabet_/"; 
        // -----------------------------------
        
        // --- LISTE DES MOTS CENSUR√âS (EN MINUSCULES) ---
        // Liste exhaustive collect√©e via recherche Internet (gros mots, obsc√©nit√©s, termes sexuels)
        const BANNED_WORDS = [
            // Injures / Grossi√®ret√©s communes
            "putain", "bordel", "merde", "con", "conne", "conard", "connard", "salaud", "salope", "pute", 
            "chier", "foutre", "enculer", "branleur", "branleuse", "cul", "couille", "bite", "chatte",
            "ta gueule", "casse-toi", "niquer", "chiotte", "cr√©tin", "idiot", "imb√©cile", "abruti",
            "d√©bile", "bouffon", "clochard", "sodomiser", "p√©d√©", "gougnotte", "tapette", "lopette",
            "encul√©", "mongol", "n√®gre", "rastaquou√®re", "boche", "chleuh", "foutoir",
            
            // Termes sexuels/obsc√®nes
            "sexe", "sexuel", "fellation", "cunnilingus", "orgasme", "sperme", "vagin", "p√©nis", 
            "√©jaculation", "masturbation", "porno", "pornographie", "co√Øt", "levrette", "kamasutra",
            "hardcore", "pisser", "faire caca", "nunuche", "nichons", "t√©tons", "zizi", "pipi", 
            "caca", "anal", "sodomisation", "partouze", "prostitu√©e", "baise", "baiser", "verge",
            "pisser", "faire l'amour", // 'Faire l'amour' est inclus pour la prudence
            
            // Termes li√©s √† l'anatomie intime (pour la prudence)
            "anus", "vessie", "rectum", 
            
            // Autres termes jug√©s vulgaires ou discriminatoires
            "gros mot", "sangsue", "racaille", "face de cul", "mal bais√©", "bander", "gode", "trique",
            "pouffe", "poufiasse", "souillon"
        ];
        // -------------------------------------------------------------
        
        // Elements de l'interface utilisateur
        const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        
        // Liste des caract√®res sp√©ciaux (Accents fran√ßais uniquement)
        const accentedCharsMaj = [
            '√â', '√à', '√ä', '√ã', 
            '√Ä', '√Ç', 
            '√ô', '√õ', 
            '√é', '√è', 
            '√î', '√ñ', 
            '≈í', '√á'
        ];
        
        // Liste correspondante des minuscules pour les accents
        const accentedCharsMin = [
            '√©', '√®', '√™', '√´', 
            '√†', '√¢', 
            '√π', '√ª', 
            '√Æ', '√Ø', 
            '√¥', '√∂', 
            '≈ì', '√ß'
        ];
        
        // --- MAP DE DESCRIPTION DES CARACT√àRES SP√âCIAUX ET PERSONNALISATION ---
        // Cette map est utilis√©e uniquement pour le FALLBACK TTS (si le MP3 est manquant)
        const charDescriptions = {
            // Personnalisation des lettres (pour que le TTS dise "be" ou "khe")
            'A': 'a', 'a': 'a',
            'B': 'be', 'b': 'be', 
            'C': 'khe', 'c': 'khe',
            
            // Les autres lettres (D-Z) tombent par d√©faut sur leur nom (ex: 'D' -> 'D')

            // Accents
            '√â': 'e accent aigu', '√©': 'e accent aigu',
            '√à': 'e accent grave', '√®': 'e accent grave',
            '√ä': 'e accent circonflexe', '√™': 'e accent circonflexe',
            '√ã': 'e tr√©ma', '√´': 'e tr√©ma',
            '√Ä': 'a accent grave', '√†': 'a accent grave',
            '√Ç': 'a accent circonflexe', '√¢': 'a accent circonflexe',
            '√ô': 'u accent grave', '√π': 'u accent grave',
            '√õ': 'u accent circonflexe', '√ª': 'u accent circonflexe',
            '√é': 'i accent circonflexe', '√Æ': 'i accent circonflexe',
            '√è': 'i tr√©ma', '√Ø': 'i tr√©ma',
            '√î': 'o accent circonflexe', '√¥': 'o accent circonflexe',
            '√ñ': 'o tr√©ma', '√∂': 'o tr√©ma',
            '≈í': 'o e li√©s', '≈ì': 'o e li√©s',
            '√á': 'c c√©dille', '√ß': 'c c√©dille',
            
            // Compl√©ter automatiquement les lettres restantes (D-Z) pour le TTS
            ...Object.fromEntries(alphabet.split('').filter(c => !['A', 'B', 'C'].includes(c)).map(c => [c, c])),
            ...Object.fromEntries(alphabet.toLowerCase().split('').filter(c => !['a', 'b', 'c'].includes(c)).map(c => [c, c])),
        };
        // -------------------------------------------------------------
        
        // Elements de l'interface utilisateur
        const letterGrid = document.getElementById('letter-grid'); 
        const specialCharGrid = document.getElementById('special-char-grid');
        const textInput = document.getElementById('text-input');
        const speakButton = document.getElementById('speak-btn');
        const speakText = document.getElementById('speak-text');
        const aiButton = document.getElementById('ai-btn');
        const aiText = document.getElementById('ai-text');
        const messageArea = document.getElementById('message-area');
        const aiResponseArea = document.getElementById('ai-response-area');
        const aiContent = document.getElementById('ai-content');
        const aiSources = document.getElementById('ai-sources');
        const toggleBtn = document.getElementById('toggle-handwriting'); 
        const vocalToggleBtn = document.getElementById('vocal-toggle-btn'); 
        const vocalEmojiSpan = document.getElementById('vocal-emoji');
        const audioPlayer = document.getElementById('audio-player');

        // D√©finition des emojis pour la bascule
        const EMOJI_TTS = 'üëÇ'; // Oreille (TTS actif par d√©faut)
        const EMOJI_MP3 = 'üîä'; // Haut-parleur (MP3 actif)

        // Libell√©s du bouton
        const printedLabelHTML = `<span class="font-extrabold text-xl">A B C</span>`; 
        const handwritingLabelHTML = `<span class="handwriting-font-on-button font-bold text-2xl">A B C</span>`; 

        // √âtats
        let isSpeaking = false; 
        let isAILoading = false;
        let frenchVoice = null;
        let isHandwritingMode = false;
        let isVocalMP3Mode = true; // CHANGEMENT : MP3 est d√©sormais le mode par d√©faut au lancement

        // --- GESTION DE LA FILE D'ATTENTE TTS ---
        let ttsQueue = [];       
        let isProcessingQueue = false; 

        // R√©f√©rence aux boutons de la grille (initialis√©e apr√®s DOMContentLoaded)
        let gridButtons = [];
        
       // --- GESTION DE LA VOIX TTS NATIVE ---
function findFrenchVoice() {
    if (!('speechSynthesis' in window)) return null;
    
    const voices = window.speechSynthesis.getVoices();
    // Liste de noms de voix masculines fran√ßaises courantes (pour diff√©rents navigateurs/OS)
    const desiredMaleVoiceNames = ['Thomas', 'Antoine', 'Aur√©lien', 'Paul', 'Felix']; 

    let voice = null;
    
    // 1. Tenter de trouver une voix masculine fran√ßaise sp√©cifique
    voice = voices.find(v => 
        v.lang.startsWith('fr') && 
        desiredMaleVoiceNames.some(name => v.name.includes(name))
    );

    // 2. Si aucune voix masculine n'est trouv√©e, prendre la premi√®re voix fr-FR
    if (!voice) {
        voice = voices.find(v => v.lang === 'fr-FR');
    }

    // 3. Si fr-FR n'est pas trouv√©, prendre n'importe quelle voix fran√ßaise (fr-XX)
    if (!voice) {
        voice = voices.find(v => v.lang.startsWith('fr'));
    }

    // 4. Fallback vers la voix par d√©faut du syst√®me
    if (!voice) {
        voice = voices.find(v => v.default);
    }
    
    // 5. Fallback ultime vers la premi√®re voix si rien n'est trouv√©
    if (!voice && voices.length > 0) {
        voice = voices[0];
    }
    
    return voice; 


    



}
    
    // <--- Retourne la voix trouv√©e
} // <--- C'est l'accolade de FERMETURE qui manquait !

// La fonction initializeVoicesReliably peut rester inchang√©e car elle appelle celle-ci.
        initializeVoicesReliably();

        // --- LOGIQUE DE CENSURE ---
        /**
         * V√©rifie si le mot saisi est pr√©sent dans la liste des mots bannis.
         */
        function isWordBanned(word) {
            if (!word) return false;
            // Nettoyer et convertir en minuscules pour la comparaison
            const normalizedWord = word.trim().toLowerCase();
            return BANNED_WORDS.includes(normalizedWord);
        }

        /**
         * Met √† jour le libell√© du bouton de bascule.
         */
        function updateToggleLabel() {
            if (isHandwritingMode) {
                // Mode actuel : Manuscrit. On propose de retourner √† Imprim√©.
                toggleBtn.innerHTML = printedLabelHTML; 
                toggleBtn.classList.remove('bg-green-100', 'hover:bg-green-200', 'text-green-800', 'border-green-400');
                toggleBtn.classList.add('bg-indigo-100', 'hover:bg-indigo-200', 'text-indigo-600', 'border-indigo-300');
            } else {
                // Mode actuel : Imprim√©. On propose de passer √† Manuscrit.
                toggleBtn.innerHTML = handwritingLabelHTML; 
                toggleBtn.classList.remove('bg-indigo-100', 'hover:bg-indigo-200', 'text-indigo-600', 'border-indigo-300');
                toggleBtn.classList.add('bg-green-100', 'hover:bg-green-200', 'text-green-800', 'border-green-400');
            }
        }
        
        /**
         * Bascule le style de police de l'affichage des touches de la grille.
         */
        function updateGridDisplay() {
            const spans = document.querySelectorAll('.char-display');
            spans.forEach(span => {
                span.classList.toggle('handwriting-font-on-button', isHandwritingMode);
            });
        }
        
        // --- GESTION DU MODE √âCRITURE MANUSCRITE ---
        window.toggleHandwritingMode = function() {
            isHandwritingMode = !isHandwritingMode;
            
            // 1. Mise √† jour du champ de texte (Style manuscrit)
            textInput.classList.toggle('handwriting-mode', isHandwritingMode);

            // 2. Mise √† jour de l'affichage des boutons de la grille
            updateGridDisplay();

            // 3. Mise √† jour du bouton de bascule
            updateToggleLabel();
            
            // 4. Si on change de mode, effacer le contenu pour √©viter les incoh√©rences de casse
            clearText();
            window.displayMessage(isHandwritingMode ? "Mode √âcriture Manuscrite (affichage et insertion minuscules) activ√©." : "Mode √âcriture Imprim√©e (affichage et insertion majuscules) activ√©.", false);
        }
        
        // --- GESTION DU MODE VOCAL MP3 (TTS vs MP3) ---
        window.toggleVocalMode = function() {
            isVocalMP3Mode = !isVocalMP3Mode;
            
            // 1. Annuler toute lecture en cours (TTS ou MP3)
            window.speechSynthesis.cancel();
            audioPlayer.pause();
            audioPlayer.currentTime = 0;

            // Mise √† jour de l'emoji et des classes CSS
            if (isVocalMP3Mode) {
                // Passage en mode MP3 Vocal (Haut-parleur actif)
                vocalEmojiSpan.textContent = EMOJI_MP3;
                vocalToggleBtn.classList.remove('tts-active');
                vocalToggleBtn.classList.add('mp3-active');
                window.displayMessage("Mode Vocal Personnalis√© (MP3) ACTIF. Le clic sur une lettre jouera un MP3 depuis GitHub. (Utilise un repli TTS si l'audio MP3 est manquant)", false);
                
                // Vider la queue TTS et arr√™ter le traitement
                ttsQueue = [];
                isProcessingQueue = false;
                setLoadingTTS(false);

            } else {
                // Passage en mode TTS Natif (Oreille active)
                vocalEmojiSpan.textContent = EMOJI_TTS;
                vocalToggleBtn.classList.remove('mp3-active');
                vocalToggleBtn.classList.add('tts-active');
                window.displayMessage("Mode Synth√®se Vocale (TTS) ACTIF. Le clic sur une lettre utilisera la voix native.", false);
            }
            
            // Assurez-vous que le bouton de lecture g√©n√©rale (speak-btn) refl√®te l'√©tat correct
            updateButtonStates(textInput.value);
        }

        /**
         * Cherche la minuscule correspondante pour un caract√®re accentu√© majuscule.
         */
        function getLowerAccent(char) {
            const index = accentedCharsMaj.indexOf(char);
            return index !== -1 ? accentedCharsMin[index] : char;
        }


        /**
         * Construit et affiche la grille de l'Alphabet.
         */
        function initializeGrid() {
            letterGrid.innerHTML = ''; 
            specialCharGrid.innerHTML = ''; 
            gridButtons = []; 

            // 1. Peupler la grille de l'Alphabet (A-Z)
            alphabet.split('').forEach(char => {
                const button = createGridButton(char, 'btn-letter');
                letterGrid.appendChild(button);
                gridButtons.push(button);
            });

            // 2. Peupler la grille des Caract√®res Sp√©ciaux
            accentedCharsMaj.forEach(char => {
                const button = createGridButton(char, 'btn-special');
                specialCharGrid.appendChild(button);
                gridButtons.push(button);
            });

            updateToggleLabel(); // Initialiser le libell√© du bouton au chargement
            updateGridDisplay(); // Appliquer le style initial
            
            // Initialisation de l'√©tat vocal (MP3 par d√©faut)
            if (isVocalMP3Mode) {
                vocalEmojiSpan.textContent = EMOJI_MP3;
                vocalToggleBtn.classList.add('mp3-active');
            } else {
                 vocalEmojiSpan.textContent = EMOJI_TTS;
                 vocalToggleBtn.classList.add('tts-active');
            }
        }

        /**
         * Cr√©e un bouton pour la grille.
         */
        function createGridButton(char, typeClass) {
            const button = document.createElement('button');
            
            // D√©terminer le caract√®re minuscule √† afficher
            let lowerChar;
            if (alphabet.includes(char)) {
                lowerChar = char.toLowerCase();
            } else {
                lowerChar = getLowerAccent(char);
            }
            
            // Les spans ont la classe 'char-display' qui sera bascul√©e par JS
            button.innerHTML = `
                <span class="char-upper char-display">${char}</span>
                <span class="char-lower char-display">${lowerChar}</span>
            `;
            
            const buttonClass = `p-3 font-bold rounded-lg hover:opacity-80 active:opacity-60 ${typeClass}`;

            button.className = buttonClass;
            button.dataset.char = char; // Stocker le caract√®re MAJUSCULE √† l'origine
            button.onclick = () => appendLetterAndSpeak(char); 
            return button;
        }


        /**
         * Affiche un message d'information ou d'erreur dans la zone d√©di√©e.
         */
        window.displayMessage = function(message, isError) {
            if (message) {
                messageArea.textContent = message;
                messageArea.classList.remove('hidden', 'bg-red-100', 'border-red-300', 'text-red-800', 'bg-yellow-100', 'border-yellow-300', 'text-yellow-800');
                
                if (isError) {
                    messageArea.classList.add('bg-red-100', 'border-red-300', 'text-red-800');
                } else {
                    messageArea.classList.add('bg-yellow-100', 'border-yellow-300', 'text-yellow-800');
                }
            } else {
                messageArea.classList.add('hidden');
            }
        }
        
        /**
         * Met √† jour l'√©tat de tous les boutons d'action.
         */
        window.updateButtonStates = function(value) {
            const trimmedValue = value.trim();
            const wordPresent = trimmedValue.length > 0;
            // On v√©rifie le premier mot seulement pour la censure (car l'IA ne g√®re qu'un mot)
            const firstWord = trimmedValue.split(/\s+/).filter(w => w.length > 0)[0] || '';
            const isMultiWord = trimmedValue.split(/\s+/).filter(w => w.length > 0).length > 1;
            
            // NOUVEAU: V√©rification de la censure
            const isBanned = isWordBanned(firstWord);

            // Logique pour le bouton TTS (Parler)
            const speakDisabled = isSpeaking || !wordPresent || isAILoading; 
            speakButton.disabled = speakDisabled;

            // Logique pour le bouton IA (Doit √™tre d√©sactiv√© si banni ou multi-mot)
            const aiDisabled = isAILoading || isSpeaking || !wordPresent || isMultiWord;
            aiButton.disabled = aiDisabled;
            
            // Mise √† jour du placeholder pour guider l'utilisateur
            textInput.placeholder = (aiDisabled && isMultiWord) ? 
                "Veuillez entrer un seul mot pour la d√©finition IA..." : 
                "Le texte s'affiche ici... (Max 1 mot pour la d√©finition IA)";
            
            // Mise √† jour du libell√© du bouton IA si le mot est banni
            if (isBanned && !isMultiWord) {
                 aiText.textContent = 'Mot Banni (IA Bloqu√©e)';
                 aiButton.disabled = false; // Permettre le clic pour voir le message de censure
                 aiButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                 aiButton.classList.remove('bg-purple-600', 'hover:bg-purple-700');
            } else if (isAILoading) {
                 aiText.textContent = 'Chargement...';
                 aiButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                 aiButton.classList.add('bg-purple-600', 'hover:bg-purple-700');
            } else {
                 aiText.textContent = 'D√©finition & Exemple (IA)';
                 aiButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                 aiButton.classList.add('bg-purple-600', 'hover:bg-purple-700');
            }

            // Mise √† jour du libell√© du bouton Parler
            if (isBanned && !isSpeaking) {
                 speakText.textContent = 'Mot Banni (Lire)';
                 speakButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                 speakButton.classList.remove('bg-green-600', 'hover:bg-green-700');
            } else if (isSpeaking) {
                 speakText.textContent = 'En cours...';
                 speakButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                 speakButton.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                 speakText.textContent = 'Parler';
                 speakButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                 speakButton.classList.add('bg-green-600', 'hover:bg-green-700');
            }
        }

        function setLoadingTTS(isLoading) {
            isSpeaking = isLoading;
            updateButtonStates(textInput.value);
        }
        
        function setLoadingAI(isLoading) {
            isAILoading = isLoading;
            updateButtonStates(textInput.value);
            
            if (isLoading) {
                // Masquer la r√©ponse pr√©c√©dente et afficher un indicateur
                aiResponseArea.classList.remove('hidden');
                aiContent.innerHTML = '<div class="flex justify-center items-center"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-8 w-8"></div><span class="ml-3 text-gray-600">Recherche de la d√©finition...</span></div>';
                aiSources.innerHTML = '';
            } else if (aiContent.innerHTML.trim() === '') {
                 // Masquer si la requ√™te est termin√©e mais qu'il n'y a pas de contenu
                 aiResponseArea.classList.add('hidden');
            }
        }

        /**
         * Parle un morceau de texte unique en utilisant la voix TTS native, sans g√©rer la file d'attente.
         * Utile pour la censure ou le mode fallback MP3.
         * @param {string} text Le texte √† lire.
         */
        function speakWithTTS(text) {
            // 1. Nettoyage de l'√©tat audio
            window.speechSynthesis.cancel();
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            setLoadingTTS(true);

            function attemptSpeak() {
                // Tenter de re-trouver la voix juste avant de parler
                if (frenchVoice === null) {
                    frenchVoice = findFrenchVoice();
                }
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'fr-BE'; 
                if (frenchVoice) { utterance.voice = frenchVoice; }

                utterance.onend = () => {
                    setLoadingTTS(false);
                };
                
                utterance.onerror = (event) => {
                    // Log plus explicite en cas d'√©chec du TTS
                    console.error('Erreur de lecture TTS native (fallback) - Tentative √©chou√©e:', event, `Texte: ${text}`);
                    setLoadingTTS(false);
                    //window.displayMessage(`Avertissement TTS: Lecture du mot '${text.substring(0, 15)}...' √©chou√©e.`, true);
                };
                
                try {
                    // Tenter de parler
                    window.speechSynthesis.speak(utterance);
                } catch (e) {
                    console.error("Erreur critique lors de l'appel √† speechSynthesis.speak() :", e);
                    setLoadingTTS(false);
                    window.displayMessage(`Erreur interne TTS: Impossible de d√©marrer la synth√®se vocale pour '${text.substring(0, 15)}...'.`, true);
                }
            }

            // Utilisez un petit d√©lai (50ms) pour garantir que le contexte du navigateur est pr√™t,
            // surtout apr√®s une autre tentative audio (MP3 ou TTS en erreur).
            setTimeout(attemptSpeak, 50);
        }
        
        /**
         * Traite le prochain √©l√©ment de la file d'attente TTS.
         */
        function processQueue() {
            // Si la queue est vide ou si un traitement est d√©j√† en cours, on arr√™te.
            if (ttsQueue.length === 0 || isProcessingQueue) {
                isProcessingQueue = false;
                setLoadingTTS(false);
                return;
            }
            
            /*// Si le mode MP3 est actif, on ne fait rien pour le TTS natif.
            if (isVocalMP3Mode) {
                 ttsQueue = [];
                 isProcessingQueue = false;
                 setLoadingTTS(false);
                 return;
            }
           */
            isProcessingQueue = true;
            
            const { text } = ttsQueue[0]; 

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'fr-FR'; 
            
            // Tenter de re-trouver la voix juste avant de parler
            if (frenchVoice === null) {
                frenchVoice = findFrenchVoice();
            }
            if (frenchVoice) { utterance.voice = frenchVoice; }
            
            // Lancer la lecture
            utterance.onend = () => {
                ttsQueue.shift(); // Retire le premier √©l√©ment
                isProcessingQueue = false;
                processQueue(); // Passe √† l'√©l√©ment suivant
            };
            
            utterance.onerror = (event) => {
                console.error('Erreur de lecture TTS native:', event);
                // En cas d'erreur, on retire quand m√™me l'√©l√©ment pour d√©bloquer la queue
                ttsQueue.shift(); 
                isProcessingQueue = false;
                processQueue();
            };
            
            try {
                // Lancer la lecture
                window.speechSynthesis.speak(utterance);
            } catch (e) {
                console.error("Erreur critique lors de l'appel √† speechSynthesis.speak() dans la queue :", e);
                // Si l'appel a √©chou√© imm√©diatement, on retire l'√©l√©ment et on passe au suivant
                ttsQueue.shift(); 
                isProcessingQueue = false;
                processQueue();
            }
        }

        /**
         * Tente de charger et de jouer un fichier MP3, avec FALLBACK TTS en cas d'√©chec.
         * @param {string} url L'URL compl√®te du fichier MP3.
         * @param {string} charOrWord Le caract√®re ou le mot √† prononcer (utilis√© pour le fallback et le message).
         */
        function playMP3(url, charOrWord) {
            // Annuler la lecture TTS et remettre le bouton √† Parler avant de jouer
            window.speechSynthesis.cancel();
            setLoadingTTS(false); 
            
            audioPlayer.src = url;
            
            // √âcouteur d'erreur pour ce chargement (par exemple, 404/MIME)
            function handleMP3Error() {
                audioPlayer.removeEventListener('error', handleMP3Error);
                console.error(`MP3 Playback Error: Failed to load '${url}'.`, { url, charOrWord });
                
                // *** FALLBACK EN TTS NATIVE ***
               // //window.displayMessage(`√âchec de lecture MP3 pour '${charOrWord.toUpperCase()}'. Lecture en voix native (TTS) activ√©e.`, true);
                
                // Trouver le texte phon√©tique √† lire pour le TTS
                // On utilise la majuscule du caract√®re (ou du premier caract√®re du mot) pour chercher la description
                const key = charOrWord.length > 1 ? charOrWord.toUpperCase() : charOrWord.toUpperCase().charAt(0);
                const textToSpeak = charDescriptions[key] || charOrWord;
                
                speakWithTTS(textToSpeak); // Utiliser la voix native
            }
            audioPlayer.addEventListener('error', handleMP3Error);

            audioPlayer.load();

            // Tenter de jouer
            audioPlayer.play().then(() => {
                // Lecture r√©ussie (on retire l'√©couteur d'erreur pour √©viter les faux positifs futurs)
                audioPlayer.removeEventListener('error', handleMP3Error);
                window.displayMessage(`Mode MP3 ACTIF : Lecture du son pour '${charOrWord.toUpperCase()}' en cours.`, false);
            }).catch(e => {
                // Erreur de play() (par exemple, interaction utilisateur requise ou probl√®me du navigateur)
                console.error("Erreur de play() MP3:", e.message || e);
                // Si l'erreur est li√©e au chargement (404/MIME), handleMP3Error est d√©j√† appel√©.
                // Sinon, si le navigateur n'a pas pu trouver la source du tout, force le fallback.
                if (audioPlayer.networkState === audioPlayer.NETWORK_NO_SOURCE) {
                    handleMP3Error(); 
                }
            });
        }


        /**
         * Ajout d'une lettre et d√©clenchement de la lecture.
         */
        window.appendLetterAndSpeak = function(char) {
            let charToInsert = char; // Par d√©faut, la majuscule

            // --- Logique d'insertion de la Casse ---
            if (isHandwritingMode) {
                 // Mode Manuscrit : on ins√®re la minuscule correspondante
                if (alphabet.includes(char)) {
                     charToInsert = char.toLowerCase();
                } else if (accentedCharsMaj.includes(char)) {
                     charToInsert = getLowerAccent(char);
                }
            }

            textInput.value += charToInsert;
            updateButtonStates(textInput.value);

            // Si le mode Vocal MP3 est actif, on lit le MP3 du caract√®re
            if (isVocalMP3Mode) {
                 // 1. Annuler la lecture en cours au cas o√π un autre MP3 est jou√©
                 audioPlayer.pause();
                 audioPlayer.currentTime = 0;
                 
                 const charToFind = charToInsert.toLowerCase(); // Utiliser la minuscule pour le nom de fichier (ex: 'a.mp3')
                 
                 // Construction de l'URL pour TOUS les caract√®res (lettres et accents)
                 const mp3Url = MP3_BASE_URL + charToFind + ".mp3";
                 
                 // Utiliser la nouvelle fonction plus robuste avec fallback
                 playMP3(mp3Url, charToFind);

                 return; // Arr√™ter la lecture TTS
            }

            // --- LOGIQUE TTS NATIVE (FALLBACK) ---
            // Charger la voix si n√©cessaire
            if (frenchVoice === null) {
                frenchVoice = findFrenchVoice();
            }
            
            // On utilise la valeur de charDescriptions pour la lecture TTS
            let textToSpeak = charDescriptions[char] || char; 
            
            // AJOUT √Ä LA FILE D'ATTENTE TTS NATIVE
            ttsQueue.push({ text: textToSpeak, isWord: false, isCharDescription: true });
            
            // Si le traitement n'est pas d√©j√† en cours, on le lance
            if (!isProcessingQueue) {
                setLoadingTTS(true); // Indiquer que la lecture a commenc√©
                processQueue();
            }
        }

        window.clearText = function() {
            textInput.value = '';
            
            // Arr√™ter toute lecture en cours (TTS et MP3)
            window.speechSynthesis.cancel();
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            
            // VIDER LA QUEUE lors de l'effacement
            ttsQueue = [];
            isProcessingQueue = false;
            
            setLoadingTTS(false);
            setLoadingAI(false);
            updateButtonStates('');
            window.displayMessage("", false); 
            aiResponseArea.classList.add('hidden'); // Masquer la zone IA
            aiContent.innerHTML = '';
            aiSources.innerHTML = '';
        }

        /**
         * G√®re la lecture du mot complet avec Censure.
         */
        window.generateAndPlayWordAudio = function() {
            if (isSpeaking) return;

            const textToSpeak = textInput.value.trim();
            if (textToSpeak === '') {
                window.displayMessage("Veuillez saisir du texte ou cliquer sur les lettres.", false);
                return;
            }
            
            const firstWord = textToSpeak.split(/\s+/).filter(w => w.length > 0)[0] || '';

            // 1. V√âRIFICATION DE LA CENSURE
            if (isWordBanned(firstWord)) {
                window.displayMessage("Censure: La lecture de ce mot est bloqu√©e.", true);
                
                // Jouer un message de censure au lieu du mot
                const censoredMessage = "Mot banni. Veuillez choisir un autre mot.";
                
                // Arr√™ter toute lecture en cours (TTS et MP3)
                window.speechSynthesis.cancel();
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                ttsQueue = [];
                isProcessingQueue = false;
                
                // Utiliser la fonction simple TTS pour le message de censure (pas besoin de la queue)
                speakWithTTS(censoredMessage);
                return;
            }
            
            // 2. LECTURE EN MODE MP3
            if (isVocalMP3Mode) {
                 // 1. Annuler la lecture en cours au cas o√π un autre MP3 est jou√©
                 audioPlayer.pause();
                 audioPlayer.currentTime = 0;
                 
                 // Logique pour un mot complet : Supprime tout ce qui n'est pas lettre ou accent (pour correspondre au nom de fichier)
                 const mp3FileName = textToSpeak.toLowerCase().replace(/[^a-z0-9√©√®√™√´√†√¢√π√ª√Æ√Ø√¥√∂≈ì√ß]/g, ''); 
                 const mp3Url = MP3_BASE_URL + mp3FileName + ".mp3";
                 
                 // Utiliser la nouvelle fonction plus robuste avec fallback
                 playMP3(mp3Url, mp3FileName);
                 return;
            }


            // 3. LECTURE EN MODE TTS NATIVE
            if (frenchVoice === null) {
                frenchVoice = findFrenchVoice();
            }

            // Annuler toute lecture en cours et vider la queue de caract√®res
            window.speechSynthesis.cancel();
            ttsQueue = [];
            isProcessingQueue = false;

            // Mettre le bouton en mode 'En cours...'
            setLoadingTTS(true);
            
            // Ajouter le mot complet √† la queue 
            ttsQueue.push({ text: textToSpeak, isWord: true, isCharDescription: false }); 
            
            // Lancer le traitement de la queue
            processQueue();
        }
        
        
        /**
         * G√®re l'affichage de la r√©ponse de l'IA (texte format√© et sources) ET d√©clenche la lecture.
         */
        function displayAIResponse(rawText, sources) {
            aiResponseArea.classList.remove('hidden');
            
            const word = textInput.value.trim().toUpperCase();
            
            // Formater le texte pour l'affichage (remplacer les \n par des <br>)
            let formattedText = rawText.replace(/D√©finition:\s*/, '<b>D√©finition :</b> ').replace(/Exemple:\s*/, '<br><br><b>Exemple :</b> ');
            formattedText = formattedText.replace(/\n/g, '<br>');

            aiContent.innerHTML = `
                <h3 class="text-xl font-bold mb-2 text-purple-700">${word}</h3>
                <p class="text-gray-700">${formattedText}</p>
            `;
            
            if (sources && sources.length > 0) {
                let sourcesHtml = 'Sources : ';
                sources.forEach((source, index) => {
                    sourcesHtml += `<a href="${source.uri}" target="_blank" class="text-blue-500 hover:underline">${source.title}</a>${index < sources.length - 1 ? ' | ' : ''}`;
                });
                aiSources.innerHTML = sourcesHtml;
            } else {
                aiSources.innerHTML = 'Source : Aucune source web utilis√©e.';
            }

            // *** D√©clenchement de la lecture de la r√©ponse de l'IA ***
            // La lecture de la d√©finition n'est d√©clench√©e que si le mot n'est PAS banni.
            const textToRead = `${word}. Voici la d√©finition. ${rawText.replace(/\n/g, '. ')}`;
            
            // 1. Vider toute queue en cours (TTS et MP3)
            window.speechSynthesis.cancel();
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            ttsQueue = [];
            isProcessingQueue = false;
            
            // 2. Mettre le mot √† lire dans la queue
            ttsQueue.push({ text: textToRead, isWord: true, isCharDescription: false });
            
            // 3. Lancer la lecture (avec un petit d√©lai pour la stabilit√©)
            setTimeout(() => {
                setLoadingTTS(true);
                processQueue(); 
            }, 50); 
        }

        /**
         * Appelle l'API Gemini pour obtenir une d√©finition et un exemple pour le mot donn√©.
         */
// Remplace l'ancienne fonction window.fetchGeminiDefinition par le nouvel appel proxy Netlify
window.callAIGemini = async function(word) {
    const champTexte = document.getElementById('text-input'); 
    const texteSaisi = champTexte ? champTexte.value : '';

    const aiContentArea = document.getElementById('ai-content'); 
    const messageArea = document.getElementById('message-area'); 
    const aiResponseArea = document.getElementById('ai-response-area');
    const aiSources = document.getElementById('ai-sources');
    
    // Annuler l'affichage pr√©c√©dent du message g√©n√©ral pour ne garder que le statut IA
    window.displayMessage("", false); 
    
    // V√©rification de base
    const trimmedWord = texteSaisi.trim();
    const firstWord = trimmedWord.split(/\s+/).filter(w => w.length > 0)[0] || '';
    const isMultiWord = firstWord !== trimmedWord;
    const isBanned = isWordBanned(firstWord);

    if (trimmedWord === '' || isMultiWord || isBanned) {
        if (isBanned) {
            window.displayMessage(`Censure: Le mot '${firstWord}' est bloqu√©. L'IA n'est pas consult√©e.`, true);
        } else if (isMultiWord) {
            window.displayMessage("Veuillez entrer un seul mot dans le champ pour obtenir une d√©finition IA.", true);
        } else {
            window.displayMessage("Veuillez entrer du texte dans le champ avant d'utiliser l'IA.", true);
        }
        aiResponseArea.classList.add('hidden');
        return;
    }

    setLoadingAI(true);
    aiResponseArea.classList.remove('hidden');
    aiContentArea.innerHTML = '<div class="flex justify-center items-center"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-8 w-8"></div><span class="ml-3 text-gray-600">Connexion au serveur IA en cours...</span></div>';


    try {
        const PROMPT = `Donne une d√©finition simple et courte (pour enfant) du mot '${firstWord}' et un exemple de phrase l'utilisant. Le tout doit √™tre en fran√ßais. Formatage : D√©finition: [D√©finition]. Exemple: [Exemple].`;
        
        const response = await fetch('/.netlify/functions/index', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ prompt: PROMPT }), 
        });

        const data = await response.json();

        if (response.ok && data.result) {
            // Succ√®s : Afficher la r√©ponse de l'IA
            aiContentArea.textContent = data.result;
            aiSources.innerHTML = 'Source : Google Gemini (IA)';
            window.displayMessage(`D√©finition IA re√ßue pour '${firstWord}'.`, false); 
            
        } else {
            // Erreur du serveur (400, 500, ou r√©ponse sans 'result')
            const errorMessage = `Erreur de l'IA : ${data.error || 'Requ√™te √©chou√©e ou r√©ponse vide.'}`;
            aiContentArea.textContent = errorMessage;
            aiSources.innerHTML = 'Source : Erreur';
            window.displayMessage(`√âchec de la requ√™te IA.`, true);
        }
    } catch (error) {
        // Erreur r√©seau ou parsing JSON inattendu c√¥t√© client
        console.error('Erreur Fetch ou r√©seau:', error);
        aiContentArea.textContent = `Erreur Critique : Impossible de joindre le proxy Netlify. (${error.message})`;
        aiSources.innerHTML = 'Source : Erreur Critique';
        window.displayMessage(`Erreur Critique : Impossible de joindre le proxy Netlify.`, true);
        
    } finally {
        setLoadingAI(false);
    }
}

        document.addEventListener('DOMContentLoaded', () => {
            initializeGrid();
            updateButtonStates(textInput.value); // Initialiser l'√©tat des boutons au chargement
            
            // Afficher le message initial pour le mode MP3 actif
            if (isVocalMP3Mode) {
                 window.displayMessage("Mode Vocal Personnalis√© (MP3) ACTIF par d√©faut. Le clic sur une lettre jouera un MP3.", false);
            }
        });
    </script>
</body>
</html>


















